{% extends "base.html" %}
{% block content %}
<h2>Chat</h2>
<div id="chat-window" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;">
    <!-- Chat messages will appear here -->
</div>
<form id="chat-form">
    <div class="form-group">
        <input type="text" id="message" class="form-control" placeholder="Type your message here..." required>
    </div>
    <button type="submit" class="btn btn-success">Send</button>
</form>
{% endblock %}

{% block scripts %}
<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCCvv3AS7aCTKEjrvM_PccLqKPSQCyUHyI",
  authDomain: "fluence-7fc9f.firebaseapp.com",
  projectId: "fluence-7fc9f",
  storageBucket: "fluence-7fc9f.firebasestorage.app",
  messagingSenderId: "754828040050",
  appId: "1:754828040050:web:359c191ff83e9751186feb"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const chatId = "{{ chat_id }}";
    const chatWindow = document.getElementById("chat-window");
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message");
    
    // Get sender email safely
    let sender = "{{ session['user']['email'] if 'user' in session else 'Guest' }}";
    
    // Function to sanitize text input
    function sanitizeText(text) {
        return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
    
    // Listen for new messages
    db.collection("chats").doc(chatId).collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        chatWindow.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const msgDiv = document.createElement("div");
          msgDiv.textContent = msg.sender + ": " + msg.text;
          chatWindow.appendChild(msgDiv);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
    });
    
    // Send a message
    chatForm.addEventListener("submit", e => {
        e.preventDefault();
        const text = sanitizeText(messageInput.value);
        db.collection("chats").doc(chatId).collection("messages").add({
            
            sender: sender,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            messageInput.value = "";
        }).catch(error => {
            console.error("Error sending message: ", error);
        });
    });
    </script>
    
{% endblock %}
